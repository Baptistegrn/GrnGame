name: Build macOS (ARM64)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

# Permissions pour permettre le push avec GITHUB_TOKEN
permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      # Checkout du dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # Installer xmake
      - name: Setup xmake
        uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      # Cache des packages xmake
      - name: Cache xmake packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.xmake/packages
            ~/.xmake/cache
          key: ${{ runner.os }}-xmake-${{ hashFiles('**/xmake.lua') }}
          restore-keys: |
            ${{ runner.os }}-xmake-

      # Vérification du répertoire courant
      - name: Vérifier répertoire courant
        run: |
          pwd
          ls -la

      # Configurer xmake
      - name: Configurer xmake
        run: xmake f -p macosx -a arm64 -y -v 

      # Build
      - name: Compiler
        run: xmake -v

      # Configurer xmake en debug
      - name: Configurer xmake (debug)
        run: xmake f -p macosx -a arm64 -y -v --debug=yes

      # Build
      - name: Compiler (debug)
        run: xmake -v

      # Commit automatique des binaires
      - name: Commit automatique des binaires
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add bin/release/**
          git add debug/release/**
          git commit -m "Ajout des binaires macOS depuis le workflow" || echo "Aucun changement à committer"

      # Pousser le commit
      - name: Pousser le commit
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
